#! /bin/sh
#
#   Copyright 2010 Free Software Foundation, Inc.
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

arg=$1
if [ "$arg" != "" ]
then shift
fi

prefix=@prefix@
exec_prefix=@exec_prefix@
udevdir=/lib/udev
rulesdir=$udevdir/rules.d
archive=$udevdir/arch
scripts=@libdir@/gnuspool/udev

rulefile=70-gspl-printers.rules
confscript=udev-configure-gnuspool

checkfunc() {
    lines=`fgrep 'GROUP="lp"' $rulesdir/*|fgrep -c 'OWNER="gnuspool"'`
    if [ $lines -eq 0 ]
    then return 0
    else return 1
    fi
}

case "$arg" in
--help|help|'?')
	cat <<EOF
This script can be used to adjust the "udev" scripts to reflect the requirements
of GNUspool.

Printers will be set to be owner by "gnuspool" and start/stop scripts will
be set appropriately.

Invoke with argument:

help - this message
check - display whether patch installed
install - install patch
uninstall - revert patch
EOF
	exit 0;;

--check|check)
	if checkfunc
	then
	    echo The patch has not been installed
	else
	    echo The patch HAS been installed
	fi
	exit 0;;

--install|install)
	if ! checkfunc
	then
	    echo The patch has already been installed
	    exit 2
	fi
	cd $rulesdir
	if [ ! -d $archive ]
	then mkdir $archive || exit 3
	fi
	pfiles=`fgrep -l 'GROUP="lp"' [0-9]*`
	afiles=`fgrep -l 'configure-printer' [0-9]*`
	if [ -z "$pfiles" ]
	then
	    echo Cannot find any rules with lp in to edit
	    exit 3
	fi
	for pf in $pfiles
	do
	    echo "Editing $rulesdir/$pf"
	    cp $pf $archive
	    sed -e 's/GROUP="lp"/OWNER="gnuspool", GROUP="lp"/' $archive/$pf >$pf
	done
	if [ -n "$afiles" ]
	then
	    echo "Moving $afiles to archive"
	    mv $afiles $archive
	fi
	cp $scripts/$rulefile .
	cd $udevdir
	cp $scripts/$confscript .

	exit 0;;

--uninstall|uninstall)
	if checkfunc
	then
	    echo The patch has not been installed
	    exit 4
	fi
	if [ ! -d $archive ]
	then
	    echo Cannot find the archive directory $archive
	    exit 5
	fi

	rm -f $rulesdir/$rulefile $udevdir/$confscript

	if ! mv $archive/* $rulesdir
	then
	    excho Cannor move files from archive directory $archive to $rulesdir
	    exit 6
	fi
	rm -rf $archive
	exit 0;;

*)
	echo Usage: $0 help/check/install/uninstall
	exit 1;;
esac
