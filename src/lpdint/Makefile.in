#
#   Copyright 2008 Free Software Foundation, Inc.
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#	Makefile for LPD interface programs
#

SHELL		=	/bin/sh
@SET_MAKE@
prefix		=	@prefix@
exec_prefix	=	@exec_prefix@
PARENT		=	..
BASE		=	../..
HDRS		=	$(PARENT)/hdrs
CC		=	@CC@
CCFLAGS		=	-O @gcc_useful_options@ @funny_compiler_options@
LDFLAGS		=
LIBNET		=	@SOCKLIBS@
LIBS		=	@LIBS@
CFLAGS		=	$(CCFLAGS) -I$(HDRS) -I$(BASE) -I$(PARENT)
MYLIBDIR	=	$(PARENT)/lib
LIB		=	$(MYLIBDIR)/libgnuspool_int.a
SHLIB		=	$(MYLIBDIR)/libgnuspool_int.so
RM		=	rm -f
INSTALL		=	@INSTALL@
INSTALL_DATA	=	@INSTALL_DATA@
SPOOLUSER	=	@SPOOLUSER@
USERMODES	=	-o $(SPOOLUSER) -g root -m 4755
ROOTMODES	=	-o root -g root -m 4755
BINDIR		=	@bindir@
INTBINDIR	=	@pkgexecdir@
DATADIR		=	@pkgdatadir@
HELPFILEDIR	=	@sphelpdir@

all:	@main_target@

nonshared:	xtlpd xtlpc xtlpq xtlprm gspl-lpq gspl-lprm

shared:	xtlpd_s xtlpc_s xtlpq_s xtlprm_s sp.lpq_s sp.lprm_s

xtlpd:	xtlpd.o lpdparse.o proccmd.o lpdproto.o
	$(CC) $(LDFLAGS) -o $@ xtlpd.o lpdparse.o proccmd.o lpdproto.o $(LIB) $(LIBNET) $(LIBS)

xtlpd_s:xtlpd.o lpdparse.o proccmd.o lpdproto.o
	$(CC) $(LDFLAGS) -o xtlpd xtlpd.o lpdparse.o proccmd.o lpdproto.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

xtlpc:	xtlpc.o lpcparse.o
	$(CC) $(LDFLAGS) -o $@ xtlpc.o lpcparse.o $(LIB) $(LIBNET) $(LIBS)

xtlpc_s:xtlpc.o lpcparse.o
	$(CC) $(LDFLAGS) -o xtlpc xtlpc.o lpcparse.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

xtlpq:	xtlpq.o
	$(CC) $(LDFLAGS) -o xtlpq xtlpq.o $(LIB) $(LIBNET) $(LIBS)

xtlpq_s:xtlpq.o
	$(CC) $(LDFLAGS) -o xtlpq xtlpq.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

xtlprm:	xtlprm.o
	$(CC) $(LDFLAGS) -o xtlprm xtlprm.o $(LIB) $(LIBNET) $(LIBS)

xtlprm_s:xtlprm.o
	$(CC) $(LDFLAGS) -o xtlprm xtlprm.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

gspl-lpq:	sp.lpq.o
	$(CC) $(LDFLAGS) -o $@ sp.lpq.o $(LIB) $(LIBS)

sp.lpq_s:sp.lpq.o
	$(CC) $(LDFLAGS) -o gspl-lpq sp.lpq.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

gspl-lprm:	sp.lprm.o
	$(CC) $(LDFLAGS) -o $@ sp.lprm.o $(LIB) $(LIBS)

sp.lprm_s:	sp.lprm.o
	$(CC) $(LDFLAGS) -o gspl-lprm sp.lprm.o $(SHLIB) $(LIBNET) $(LIBS)
	touch $@

xtlprm.o:	xtlpq.c
	ln xtlpq.c xtlprm.c
	$(CC) -c $(CCFLAGS) -I$(HDRS) -I$(BASE) -I$(PARENT) -DXTLPRM xtlprm.c
	rm -f xtlprm.c

sp.lprm.o:	sp.lpq.c
	ln sp.lpq.c sp.lprm.c
	$(CC) -c $(CCFLAGS) -I$(HDRS) -I$(BASE) -I$(PARENT) -DSP_LPRM sp.lprm.c
	rm -f sp.lprm.c

install:	all
	$(INSTALL) $(ROOTMODES) xtlprm xtlpd xtlpq xtlpc $(INTBINDIR)
	$(INSTALL) $(USERMODES) gspl-lpq gspl-lprm $(BINDIR)
	$(INSTALL) -d $(DATADIR)
	$(INSTALL) remove longlist shortlist $(DATADIR)
	$(INSTALL) -d -o $(SPOOLUSER) -g root -m 755 @spooldir@/xtlpc @spooldir@/xtlpd
	sed -e 's|SPOOLDIR|@spooldir@|' -e 's|DATADIR|@pkgdatadir@|' xtlpc-ctrl >$(DATADIR)/xtlpc-ctrl
	sed -e 's|SPOOLDIR|@spooldir@|' -e 's|DATADIR|@pkgdatadir@|' xtlpd-ctrl >$(DATADIR)/xtlpd-ctrl
	chown $(SPOOLUSER) $(DATADIR)/xtlpc-ctrl $(DATADIR)/xtlpd-ctrl
	echo '1  BSD  -  -' >/etc/gnuspool.ext

install-strip:	all
	$(INSTALL) -s $(ROOTMODES) xtlprm xtlpd xtlpq xtlpc $(INTBINDIR)
	$(INSTALL) -s $(USERMODES) gspl-lpq gspl-lprm $(BINDIR)
	$(INSTALL) -d $(DATADIR)
	$(INSTALL) remove longlist shortlist $(DATADIR)
	$(INSTALL) -d -o $(SPOOLUSER) -g root -m 755 @spooldir@/xtlpc @spooldir@/xtlpd
	sed -e 's|SPOOLDIR|@spooldir@|' -e 's|DATADIR|@pkgdatadir@|' xtlpc-ctrl >$(DATADIR)/xtlpc-ctrl
	sed -e 's|SPOOLDIR|@spooldir@|' -e 's|DATADIR|@pkgdatadir@|' xtlpd-ctrl >$(DATADIR)/xtlpd-ctrl
	chown $(SPOOLUSER) $(DATADIR)/xtlpc-ctrl $(DATADIR)/xtlpd-ctrl
	echo '1  BSD  -  -' >/etc/gnuspool.ext

clean:
	$(RM) *.o xtlpd xtlpc xtlpq xtlprm gspl-lpq gspl-lprm *_s

distclean:	clean
	$(RM) Makefile
